# SPDX-License-Identifier: Apache-2.0

name: Release

permissions:
  pull-requests: write
  contents: write

on:
  push:
    branches:
      - main

jobs:
  bundle:
    name: Bundled Proto Sync
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
          submodules: recursive
      - uses: dtolnay/rust-toolchain@stable
      - uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Refresh bundled proto (no serde)
        run: REGENERATE_PREGENERATED=1 cargo build --no-default-features
      - name: Refresh bundled proto (serde)
        run: REGENERATE_PREGENERATED=1 cargo build --no-default-features --features serde
      - name: Detect generated changes
        id: diff
        run: |
          if [ -n "$(git status --porcelain -- gen/proto)" ]; then
            echo "changed=true" >>"$GITHUB_OUTPUT"
          else
            echo "changed=false" >>"$GITHUB_OUTPUT"
          fi
      - name: Create PR for bundled proto updates
        if: steps.diff.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: sync bundled proto"
          committer: Substrait Release Bot <releases@substrait.io>
          author: Substrait Release Bot <releases@substrait.io>
          title: "chore: sync bundled proto"
          body: |
            Automated refresh of bundled Substrait proto artifacts.

            This PR is created when pre-generated protobuf sources diverge from the current `.proto` definitions.
          branch: chore/sync-bundled-proto
          delete-branch: true
          add-paths: |
            gen/proto/**

  release:
    name: Release
    runs-on: ubuntu-24.04-arm
    environment:
      name: crates-io
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
          submodules: recursive
      - uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      - uses: dtolnay/rust-toolchain@stable
      # Trigger build script to generate version info
      - run: cargo build
      - uses: MarcoIeni/release-plz-action@v0.5.118
        with:
          command: release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}

  pr:
    name: PR
    runs-on: ubuntu-24.04-arm
    concurrency:
      group: release-${{ github.ref }}
      cancel-in-progress: false
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
          submodules: recursive
      - uses: dtolnay/rust-toolchain@stable
      - uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      - run: cargo build
      - uses: MarcoIeni/release-plz-action@v0.5.118
        with:
          command: release-pr
        env:
          RUST_LOG: debug
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}
